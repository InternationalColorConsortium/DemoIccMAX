<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iccApplyToLink Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; box-sizing: border-box; }
    label { display: block; margin-top: 0.5em; }
    select, input[type="text"], input[type="number"], input[type="file"] { display: block; margin-top: 0.25em; }
  </style>
</head>
<body>
  <h1>iccApplyToLink Tool</h1>

  <section>
    <label>ICC Profile File:
      <input type="file" id="iccProfile" />
    </label>
    <label>Destination Link Filename:
      <input type="text" id="dstLinkFile" placeholder="output.link" />
    </label>
    <label>Link Type:
      <select id="linkType" onchange="updateOptionLabel()">
        <option value="0">Device Link</option>
        <option value="1">.cube Text File</option>
      </select>
    </label>
    <label id="optionLabel">Digits of precision (for .cube):
      <input type="text" id="optionValue" value="4" />
    </label>
    <label>LUT Size:
      <input type="number" id="lutSize" value="33" />
    </label>
    <label>Title/Description:
      <input type="text" id="titleText" value="My Link Profile" />
    </label>
    <label>Range Min:
      <input type="text" id="rangeMin" value="0.0" />
    </label>
    <label>Range Max:
      <input type="text" id="rangeMax" value="1.0" />
    </label>
    <label>First Transform:
      <select id="firstTransform">
        <option value="0">Source Transform</option>
        <option value="1">Destination Transform</option>
      </select>
    </label>
    <label>Interpolation:
      <select id="interp">
        <option value="0">Linear</option>
        <option value="1">Tetrahedral</option>
      </select>
    </label>
    <label>Rendering Intent:
      <input type="text" id="renderingIntent" value="0" />
    </label>
    <button onclick="runIccApplyToLink()">Run Apply</button>
    <textarea id="applyOutput" rows="20" placeholder="Output will appear here..."></textarea>
  </section>

  <script src="iccApplyToLink.js"></script>
  <script>
    const createModule_IccApplyToLink = createModule;
    let iccApplyInstance;
    const iccApplyReady = createModule_IccApplyToLink({
      print: text => document.getElementById("applyOutput").value += text + "\n",
      printErr: text => document.getElementById("applyOutput").value += "ERR: " + text + "\n"
    }).then(mod => iccApplyInstance = mod);

    function updateOptionLabel() {
      const label = document.getElementById("optionLabel");
      const linkType = document.getElementById("linkType").value;
      label.innerText = linkType === "0" ? "Digits of precision (for .cube):" : "Profile version (0 = v4, 1 = v5):";
    }

    async function runIccApplyToLink() {
      await iccApplyReady;
      const profileFile = document.getElementById("iccProfile").files[0];
      const output = document.getElementById("applyOutput");
      output.value = "";

      if (!profileFile) {
        alert("Please upload an ICC profile file.");
        return;
      }

      const args = [
        document.getElementById("dstLinkFile").value || "output.link",
        document.getElementById("linkType").value,
        document.getElementById("lutSize").value,
        document.getElementById("optionValue").value,
        document.getElementById("titleText").value,
        document.getElementById("rangeMin").value,
        document.getElementById("rangeMax").value,
        document.getElementById("firstTransform").value,
        document.getElementById("interp").value,
        "input.icc",
        document.getElementById("renderingIntent").value
      ];

      const reader = new FileReader();
      reader.onload = () => {
        try {
          iccApplyInstance.FS.writeFile("input.icc", new Uint8Array(reader.result));
          iccApplyInstance.callMain(args);
        } catch (err) {
          console.warn("Execution error:", err.message);
          output.value += "\n[⚠️ Execution ended with errors.]\n";
        }
      };

      reader.readAsArrayBuffer(profileFile);
    }
  </script>
</body>
</html>
