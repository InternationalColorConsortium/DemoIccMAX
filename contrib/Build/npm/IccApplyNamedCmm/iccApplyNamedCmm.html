<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iccApplyNamedCmm Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; box-sizing: border-box; }
    label { display: block; margin-top: 0.5em; }
  </style>
</head>
<body>
  <header>
    <div>
      <a href="https://color.org/index.xalter">
        <img src="https://color.org/system/images/ICC_logo_text.gif" width="368" height="27" alt="International Color Consortium">
      </a>
    </div>
    <div>
      <img src="https://color.org/system/images/ICC_logo_top.gif" width="143" height="65" alt="ICC Logo">
      <img src="https://color.org/system/images/hd_images.jpg" width="657" height="46" alt="Making color seamless between devices and documents">
    </div>
  </header>

  <h1>iccApplyNamedCmm Tool</h1>

  <section>
    <label>Select Config File (.json) for Usage 1:
      <input type="file" id="configFile" />
    </label>
    <p><strong>OR</strong></p>
    <label>Data File for Usage 2:
      <input type="file" id="dataFile" />
    </label>
    <label>ICC Profile File for Usage 2:
      <input type="file" id="profileFile" />
    </label>
    <label>Additional Arguments (Usage 2 only; do not include filenames here):
      <input type="text" id="extraArgs" placeholder="0:4:9 1 1" />
    </label>
    <button onclick="runIccApply()">Run Apply</button>
    <textarea id="applyOutput" rows="20" placeholder="Apply output will appear here..."></textarea>
  </section>

  <script src="iccApplyNamedCmm.js"></script>
  <script>
    const createModule_IccApply = createModule;
    let iccApplyInstance;
    const iccApplyReady = createModule_IccApply({
      print: text => document.getElementById("applyOutput").value += text + "\n",
      printErr: text => document.getElementById("applyOutput").value += "ERR: " + text + "\n"
    }).then(mod => iccApplyInstance = mod);

    async function runIccApply() {
      await iccApplyReady;
      const config = document.getElementById("configFile").files[0];
      const data = document.getElementById("dataFile").files[0];
      const profile = document.getElementById("profileFile").files[0];
      const extra = document.getElementById("extraArgs").value.trim();

      document.getElementById("applyOutput").value = "";

      if (config) {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const content = new Uint8Array(reader.result);
            iccApplyInstance.FS.writeFile("config.json", content);
            iccApplyInstance.callMain(["-cfg", "config.json"]);
          } catch (err) {
            console.error("Error processing config file:", err);
            alert("Failed to run with config file.");
          }
        };
        reader.readAsArrayBuffer(config);
      } else if (data && profile) {
        const reader1 = new FileReader();
        const reader2 = new FileReader();

        reader1.onload = () => {
          const dataContent = new Uint8Array(reader1.result);
          iccApplyInstance.FS.writeFile("input.dat", dataContent);
          reader2.readAsArrayBuffer(profile);
        };

        reader2.onload = () => {
          try {
            const profileContent = new Uint8Array(reader2.result);
            iccApplyInstance.FS.writeFile("input.icc", profileContent);

            const args = ["input.dat"];
            if (extra) {
              args.push(...extra.split(" "));
            }
            args.push("input.icc");

            iccApplyInstance.callMain(args);
          } catch (err) {
            console.error("Error processing Usage 2 files:", err);
            alert("Failed to run with data/profile files.");
          }
        };

        reader1.readAsArrayBuffer(data);
      } else {
        alert("Please provide either a config file or both data and profile files.");
      }
    }
  </script>
</body>
</html>
