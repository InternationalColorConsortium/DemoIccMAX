<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iccV5DspObsToV4Dsp Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; box-sizing: border-box; }
    label { display: block; margin-top: 0.5em; }
    input[type="file"], input[type="text"] { margin-top: 0.25em; display: block; }
  </style>
</head>
<body>
  <h1>iccV5DspObsToV4Dsp Tool</h1>

  <section>
    <label>V5 Display ICC Profile:
      <input type="file" id="v5IccFile" />
    </label>
    <label>V5 Observer PCC File:
      <input type="file" id="v5ObsFile" />
    </label>
    <label>Output V4 Display ICC Filename:
      <input type="text" id="v4OutputName" value="output_v4.icc" />
    </label>
    <button onclick="runV5ToV4()">Run Conversion</button>
    <textarea id="outputLog" rows="20" placeholder="Output will appear here..."></textarea>
  </section>

  <script src="iccV5DspObsToV4Dsp.js"></script>
  <script>
    const createModule_V5ToV4 = createModule;
    let v5ToV4Instance;
    const ready = createModule_V5ToV4({
      print: text => document.getElementById("outputLog").value += text + "\n",
      printErr: text => document.getElementById("outputLog").value += "ERR: " + text + "\n"
    }).then(mod => v5ToV4Instance = mod);

    async function runV5ToV4() {
      await ready;
      const v5Icc = document.getElementById("v5IccFile").files[0];
      const v5Obs = document.getElementById("v5ObsFile").files[0];
      const v4Name = document.getElementById("v4OutputName").value.trim() || "output_v4.icc";

      if (!v5Icc || !v5Obs) {
        alert("Both V5 ICC and Observer PCC files are required.");
        return;
      }

      const reader1 = new FileReader();
      const reader2 = new FileReader();

      reader1.onload = () => {
        v5ToV4Instance.FS.writeFile("v5.icc", new Uint8Array(reader1.result));
        reader2.readAsArrayBuffer(v5Obs);
      };

      reader2.onload = () => {
        v5ToV4Instance.FS.writeFile("observer.pcc", new Uint8Array(reader2.result));
        try {
          v5ToV4Instance.callMain(["v5.icc", "observer.pcc", v4Name]);
        } catch (err) {
          document.getElementById("outputLog").value += "\n[⚠️ Error during execution.]\n";
        }
      };

      reader1.readAsArrayBuffer(v5Icc);
    }
  </script>
</body>
</html>
