<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iccJpegDump Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; box-sizing: border-box; }
    label { display: block; margin-top: 0.5em; }
    input[type="file"], input[type="text"], select { margin-top: 0.25em; }
  </style>
</head>
<body>
  <h1>iccJpegDump Tool</h1>

  <section>
    <label>Mode:
      <select id="mode" onchange="toggleMode()">
        <option value="extract">Extract ICC from JPEG</option>
        <option value="inject">Inject ICC into JPEG</option>
      </select>
    </label>

    <div id="extractSection">
      <label>JPEG File:
        <input type="file" id="jpegInputExtract" />
      </label>
      <label>Output ICC Filename:
        <input type="text" id="outputIccName" value="output.icc" />
      </label>
    </div>

    <div id="injectSection" style="display:none;">
      <label>JPEG File:
        <input type="file" id="jpegInputInject" />
      </label>
      <label>ICC Profile File:
        <input type="file" id="iccFileInject" />
      </label>
      <label>Output JPEG Filename:
        <input type="text" id="jpegOutputName" value="output.jpg" />
      </label>
    </div>

    <button onclick="runIccJpegDump()">Run</button>
    <textarea id="outputLog" rows="20" placeholder="Operation log will appear here..."></textarea>
  </section>

  <script src="iccJpegDump.js"></script>
  <script>
    const createModule_IccJpegDump = createModule;
    let iccJpegDumpInstance;
    const iccJpegReady = createModule_IccJpegDump({
      print: text => document.getElementById("outputLog").value += text + "\n",
      printErr: text => document.getElementById("outputLog").value += "ERR: " + text + "\n"
    }).then(mod => iccJpegDumpInstance = mod);

    function toggleMode() {
      const mode = document.getElementById("mode").value;
      document.getElementById("extractSection").style.display = mode === "extract" ? "block" : "none";
      document.getElementById("injectSection").style.display = mode === "inject" ? "block" : "none";
    }

    async function runIccJpegDump() {
      await iccJpegReady;
      const mode = document.getElementById("mode").value;
      const output = document.getElementById("outputLog");
      output.value = "";

      if (mode === "extract") {
        const jpegFile = document.getElementById("jpegInputExtract").files[0];
        const outputName = document.getElementById("outputIccName").value.trim() || "output.icc";

        if (!jpegFile) return alert("Please select a JPEG file.");

        const reader = new FileReader();
        reader.onload = () => {
          iccJpegDumpInstance.FS.writeFile("input.jpg", new Uint8Array(reader.result));
          iccJpegDumpInstance.callMain(["input.jpg", outputName]);
        };
        reader.readAsArrayBuffer(jpegFile);

      } else {
        const jpegFile = document.getElementById("jpegInputInject").files[0];
        const iccFile = document.getElementById("iccFileInject").files[0];
        const outJpeg = document.getElementById("jpegOutputName").value.trim() || "output.jpg";

        if (!jpegFile || !iccFile) return alert("Both JPEG and ICC files are required for injection.");

        const reader1 = new FileReader();
        const reader2 = new FileReader();

        reader1.onload = () => {
          iccJpegDumpInstance.FS.writeFile("input.jpg", new Uint8Array(reader1.result));
          reader2.readAsArrayBuffer(iccFile);
        };

        reader2.onload = () => {
          iccJpegDumpInstance.FS.writeFile("input.icc", new Uint8Array(reader2.result));
          iccJpegDumpInstance.callMain(["input.jpg", "--write-icc", "input.icc", "--output", outJpeg]);
        };

        reader1.readAsArrayBuffer(jpegFile);
      }
    }
  </script>
</body>
</html>
