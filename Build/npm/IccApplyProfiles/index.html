<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iccApplyProfiles Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; box-sizing: border-box; }
    label { display: block; margin-top: 0.5em; }
    select, input[type="file"] { display: block; margin-top: 0.25em; }
  </style>
</head>
<body>
  <h1>iccApplyProfiles Tool</h1>

  <section>
    <label>Source TIFF File:
      <input type="file" id="srcTiff" />
    </label>
    <label>ICC Profile File:
      <input type="file" id="iccProfile" />
    </label>
    <label>Destination Sample Encoding:
      <select id="dstEncoding">
        <option value="0">Same as src</option>
        <option value="1">icEncode8Bit</option>
        <option value="2">icEncode16Bit</option>
        <option value="4">icEncodeFloat</option>
      </select>
    </label>
    <label>Destination Compression:
      <select id="dstCompression">
        <option value="0">None</option>
        <option value="1">LZW</option>
      </select>
    </label>
    <label>Destination Planar:
      <select id="dstPlanar">
        <option value="0">Contig</option>
        <option value="1">Separation</option>
      </select>
    </label>
    <label>Embed ICC:
      <select id="dstEmbedIcc">
        <option value="0">Do Not Embed</option>
        <option value="1">Embed Last ICC</option>
      </select>
    </label>
    <label>Interpolation:
      <select id="interpolation">
        <option value="0">Linear</option>
        <option value="1">Tetrahedral</option>
      </select>
    </label>
    <label>Rendering Intent:
      <input type="text" id="renderingIntent" value="0" />
    </label>
    <button onclick="runIccApplyProfiles()">Run Apply</button>
    <textarea id="applyOutput" rows="20" placeholder="Apply output will appear here..."></textarea>
  </section>

  <script src="iccApplyProfiles.js"></script>
  <script>
    const createModule_IccApplyProfiles = createModule;
    let iccApplyProfilesInstance;
    const iccApplyReady = createModule_IccApplyProfiles({
      print: text => document.getElementById("applyOutput").value += text + "\n",
      printErr: text => document.getElementById("applyOutput").value += "ERR: " + text + "\n"
    }).then(mod => iccApplyProfilesInstance = mod);

    async function runIccApplyProfiles() {
      await iccApplyReady;
      const srcFile = document.getElementById("srcTiff").files[0];
      const profileFile = document.getElementById("iccProfile").files[0];
      const output = document.getElementById("applyOutput");
      output.value = "";

      if (!srcFile || !profileFile) {
        alert("Please provide both source TIFF and ICC profile files.");
        return;
      }

      const args = [
        "input.tif", "output.tif",
        document.getElementById("dstEncoding").value,
        document.getElementById("dstCompression").value,
        document.getElementById("dstPlanar").value,
        document.getElementById("dstEmbedIcc").value,
        document.getElementById("interpolation").value,
        "input.icc",
        document.getElementById("renderingIntent").value
      ];

      const reader1 = new FileReader();
      const reader2 = new FileReader();

      reader1.onload = () => {
        iccApplyProfilesInstance.FS.writeFile("input.tif", new Uint8Array(reader1.result));
        reader2.readAsArrayBuffer(profileFile);
      };

      reader2.onload = () => {
        iccApplyProfilesInstance.FS.writeFile("input.icc", new Uint8Array(reader2.result));

        try {
          iccApplyProfilesInstance.callMain(args);
        } catch (err) {
          console.warn("Runtime error:", err.message);
          output.value += "\n[⚠️ Execution ended with errors.]\n";
        }
      };

      reader1.readAsArrayBuffer(srcFile);
    }
  </script>
</body>
</html>
